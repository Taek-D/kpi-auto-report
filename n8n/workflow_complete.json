{"name": "ì•³í™ˆ KPI Daily Auto-Report", "nodes": [{"parameters": {"rule": {"interval": [{"field": "hours", "hoursInterval": 24}]}}, "id": "cron-trigger", "name": "Schedule: Daily 08:00", "type": "n8n-nodes-base.scheduleTrigger", "typeVersion": 1, "position": [250, 300]}, {"parameters": {"method": "POST", "url": "https://rjulhuseewaaxpbgyaah.supabase.co/rest/v1/rpc/get_brand_kpis_yesterday", "sendHeaders": true, "headerParameters": {"parameters": [{"name": "apikey", "value": "YOUR_SUPABASE_ANON_KEY"}, {"name": "Authorization", "value": "Bearer YOUR_SUPABASE_ANON_KEY"}, {"name": "Content-Type", "value": "application/json"}]}, "sendBody": true, "bodyParameters": {"parameters": []}, "options": {}}, "id": "http-yesterday", "name": "Supabase: Yesterday Brand KPIs", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [500, 80]}, {"parameters": {"method": "POST", "url": "https://rjulhuseewaaxpbgyaah.supabase.co/rest/v1/rpc/get_brand_kpis_last_week", "sendHeaders": true, "headerParameters": {"parameters": [{"name": "apikey", "value": "YOUR_SUPABASE_ANON_KEY"}, {"name": "Authorization", "value": "Bearer YOUR_SUPABASE_ANON_KEY"}, {"name": "Content-Type", "value": "application/json"}]}, "sendBody": true, "bodyParameters": {"parameters": []}, "options": {}}, "id": "http-lastweek", "name": "Supabase: Last Week Brand KPIs", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [500, 240]}, {"parameters": {"method": "POST", "url": "https://rjulhuseewaaxpbgyaah.supabase.co/rest/v1/rpc/get_top_products", "sendHeaders": true, "headerParameters": {"parameters": [{"name": "apikey", "value": "YOUR_SUPABASE_ANON_KEY"}, {"name": "Authorization", "value": "Bearer YOUR_SUPABASE_ANON_KEY"}, {"name": "Content-Type", "value": "application/json"}]}, "sendBody": true, "bodyParameters": {"parameters": []}, "options": {}}, "id": "http-products", "name": "Supabase: Top Products", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [500, 400]}, {"parameters": {"method": "POST", "url": "https://rjulhuseewaaxpbgyaah.supabase.co/rest/v1/rpc/get_competitor_changes", "sendHeaders": true, "headerParameters": {"parameters": [{"name": "apikey", "value": "YOUR_SUPABASE_ANON_KEY"}, {"name": "Authorization", "value": "Bearer YOUR_SUPABASE_ANON_KEY"}, {"name": "Content-Type", "value": "application/json"}]}, "sendBody": true, "bodyParameters": {"parameters": []}, "options": {}}, "id": "http-competitors", "name": "Supabase: Competitor Changes", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [500, 560]}, {"parameters": {"mode": "append", "numberInputs": 4}, "id": "merge-all", "name": "Merge: Collect All Data", "type": "n8n-nodes-base.merge", "typeVersion": 3, "position": [750, 300]}, {"parameters": {"jsCode": "// ============================================================================\n// File: transform.js\n// Purpose: ì•³í™ˆ ë¸Œëœë“œë³„ WoW ë¶„ì„ + ì´ìƒ íƒì§€ + ê²½ìŸì‚¬ ëª¨ë‹ˆí„°ë§ + Slack ë©”ì‹œì§€\n// Usage: n8n \"WoW Analysis & Anomaly Detection\" Code Nodeì— ë¶™ì—¬ë„£ê¸°\n// ============================================================================\n\n// ============================================================================\n// 1. Merge ë…¸ë“œì—ì„œ ë°ì´í„° ì°¸ì¡°\n// ============================================================================\n// Merge (Append) ìˆœì„œ:\n//   input 0 = Yesterday Brand KPIs (ë°°ì—´: ë¸Œëœë“œë³„ í–‰)\n//   input 1 = Last Week Brand KPIs (ë°°ì—´: ë¸Œëœë“œë³„ í–‰)\n//   input 2 = Top Products (ë°°ì—´: ìƒìœ„ ì œí’ˆ)\n//   input 3 = Competitor Changes (ë°°ì—´: ê²½ìŸì‚¬ ë³€ë™)\n\nconst allItems = $input.all();\n\n// ë°ì´í„° ì†ŒìŠ¤ë³„ ë¶„ë¦¬ (ìœ„ì¹˜ ê¸°ë°˜)\n// Merge(append)ëŠ” ëª¨ë“  ì•„ì´í…œì„ ìˆœì„œëŒ€ë¡œ í•©ì¹¨\n// ê° HTTP Requestì˜ ì‘ë‹µ í–‰ ìˆ˜ì— ë”°ë¼ ë™ì  íŒŒì‹± í•„ìš”\n\n// ë¸Œëœë“œ ëª©ë¡ (ì•³í™ˆ 3ê°œ ë¸Œëœë“œ)\nvar BRANDS = ['minix', 'thome', 'protione'];\nvar BRAND_NAMES = { minix: 'ë¯¸ë‹‰ìŠ¤', thome: 'í†°', protione: 'í”„ë¡œí‹°ì›' };\nvar BRAND_EMOJI = { minix: 'ğŸ ', thome: 'ğŸ’†', protione: 'ğŸ’ª' };\n\n// ============================================================================\n// 2. ë°ì´í„° íŒŒì‹± (Merge ì•„ì´í…œ ë¶„ë¦¬)\n// ============================================================================\n\n// ê° ì•„ì´í…œì˜ brand í•„ë“œë¡œ Yesterday/LastWeek êµ¬ë¶„\n// Yesterday ë°ì´í„°: brand í•„ë“œê°€ ìˆê³  channel_breakdown ì¡´ì¬\n// Top Products: revenue_rank í•„ë“œ ì¡´ì¬\n// Competitor: current_ranking í•„ë“œ ì¡´ì¬\n\nvar yesterdayBrands = [];\nvar lastWeekBrands = [];\nvar topProducts = [];\nvar competitors = [];\n\nfor (var i = 0; i < allItems.length; i++) {\n  var item = allItems[i].json;\n\n  if (item.revenue_rank !== undefined) {\n    // Top Products ë°ì´í„°\n    topProducts.push(item);\n  } else if (item.current_ranking !== undefined || item.ranking_change !== undefined) {\n    // Competitor ë°ì´í„°\n    competitors.push(item);\n  } else if (item.brand && item.total_revenue !== undefined) {\n    // Brand KPI ë°ì´í„° - Yesterday vs LastWeek êµ¬ë¶„\n    // Yesterday ë°ì´í„°ê°€ ë¨¼ì € ë“¤ì–´ì˜¤ê³ , LastWeekê°€ ë’¤ì— ë“¤ì–´ì˜´\n    // channel_breakdown í•„ë“œê°€ ìˆëŠ” ê²ƒì´ RPC ì‘ë‹µ\n    if (yesterdayBrands.length < BRANDS.length) {\n      yesterdayBrands.push(item);\n    } else {\n      lastWeekBrands.push(item);\n    }\n  }\n}\n\n// ============================================================================\n// 3. ë°ì´í„° ì—†ìŒ ê°ì§€\n// ============================================================================\n\nvar today = new Date().toISOString().split('T')[0];\nvar hasNoData = yesterdayBrands.length === 0;\n\nif (hasNoData) {\n  return [{\n    json: {\n      slackPayload: JSON.stringify({\n        text: 'ğŸ“Š *ì•³í™ˆ Daily KPI ë¦¬í¬íŠ¸* | ' + today + '\\n\\nâš ï¸ ì–´ì œ ë‚ ì§œì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.'\n      }),\n      metadata: { date: today, has_data: false }\n    }\n  }];\n}\n\n// ============================================================================\n// 4. WoW (Week-over-Week) ë³€í™”ìœ¨ ê³„ì‚°\n// ============================================================================\n\nfunction calculateWoW(current, previous) {\n  if (!previous || previous === 0) return null;\n  return ((current - previous) / previous) * 100;\n}\n\nfunction formatWoW(value) {\n  if (value === null) return 'N/A';\n  return (value > 0 ? '+' : '') + value.toFixed(1) + '%';\n}\n\nfunction formatWoWConvRate(value) {\n  if (value === null) return 'N/A';\n  return (value > 0 ? '+' : '') + value.toFixed(1) + '%p';\n}\n\nfunction getTrendIcon(value) {\n  if (value === null) return '';\n  if (value > 0) return 'â†‘';\n  if (value < 0) return 'â†“';\n  return 'â†’';\n}\n\nfunction formatKRW(value) {\n  return Number(value || 0).toLocaleString('ko-KR');\n}\n\n// LastWeek ë°ì´í„°ë¥¼ brand í‚¤ë¡œ ë§¤í•‘\nvar lastWeekMap = {};\nfor (var j = 0; j < lastWeekBrands.length; j++) {\n  lastWeekMap[lastWeekBrands[j].brand] = lastWeekBrands[j];\n}\n\n// ============================================================================\n// 5. ë¸Œëœë“œë³„ WoW ë¶„ì„ + ì´ìƒ íƒì§€\n// ============================================================================\n\nvar alerts = [];\nvar brandSections = [];\nvar totalRevenue = 0;\nvar totalOrders = 0;\nvar totalRevenueLastWeek = 0;\nvar totalOrdersLastWeek = 0;\n\nfor (var b = 0; b < yesterdayBrands.length; b++) {\n  var yd = yesterdayBrands[b];\n  var lw = lastWeekMap[yd.brand] || {};\n  var brandName = BRAND_NAMES[yd.brand] || yd.brand;\n  var emoji = BRAND_EMOJI[yd.brand] || 'ğŸ“Š';\n\n  totalRevenue += Number(yd.total_revenue || 0);\n  totalOrders += Number(yd.total_orders || 0);\n  totalRevenueLastWeek += Number(lw.total_revenue || 0);\n  totalOrdersLastWeek += Number(lw.total_orders || 0);\n\n  var wowRev = calculateWoW(Number(yd.total_revenue), Number(lw.total_revenue));\n  var wowOrd = calculateWoW(Number(yd.total_orders), Number(lw.total_orders));\n  var wowRoas = lw.avg_roas ? (Number(yd.avg_roas) - Number(lw.avg_roas)) : null;\n\n  // ì´ìƒ íƒì§€ (ë¸Œëœë“œë³„)\n  // í†°ì€ í™ˆì‡¼í•‘ ë°©ì†¡ì¼ì— ë³€ë™ì´ í¬ë¯€ë¡œ ë³„ë„ ì„ê³„ê°’\n  var revenueThreshold = (yd.brand === 'thome') ? -30 : -20;\n  var orderThreshold = (yd.brand === 'thome') ? -25 : -15;\n\n  if (wowRev !== null && wowRev < revenueThreshold) {\n    alerts.push('ğŸš¨ *' + brandName + '*: ë§¤ì¶œ ' + Math.abs(wowRev).toFixed(1) + '% ê°ì†Œ');\n  }\n  if (wowOrd !== null && wowOrd < orderThreshold) {\n    alerts.push('âš ï¸ *' + brandName + '*: ì£¼ë¬¸ ' + Math.abs(wowOrd).toFixed(1) + '% ê°ì†Œ');\n  }\n\n  // ì±„ë„ ìš”ì•½ (ìƒìœ„ 2ê°œ)\n  var channelInfo = '';\n  if (yd.channel_breakdown && typeof yd.channel_breakdown === 'object') {\n    var channels = Array.isArray(yd.channel_breakdown) ? yd.channel_breakdown : [];\n    if (channels.length > 0) {\n      var topChannels = channels.slice(0, 2).map(function(ch) {\n        return ch.channel + ' ' + ch.share_pct + '%';\n      });\n      channelInfo = ' (' + topChannels.join(', ') + ')';\n    }\n  }\n\n  brandSections.push(\n    emoji + ' *' + brandName + '*\\n'\n    + '  ë§¤ì¶œ: â‚©' + formatKRW(yd.total_revenue) + ' (' + formatWoW(wowRev) + ' ' + getTrendIcon(wowRev) + ')\\n'\n    + '  ì£¼ë¬¸: ' + formatKRW(yd.total_orders) + 'ê±´ | ROAS: ' + Number(yd.avg_roas || 0).toFixed(1) + channelInfo\n  );\n}\n\n// ì „ì²´ í•©ê³„ WoW\nvar totalWowRevenue = calculateWoW(totalRevenue, totalRevenueLastWeek);\nvar totalWowOrders = calculateWoW(totalOrders, totalOrdersLastWeek);\n\n// ============================================================================\n// 6. ìƒìœ„ ì œí’ˆ í¬ë§·íŒ…\n// ============================================================================\n\nvar top5Formatted = topProducts.length > 0\n  ? topProducts.slice(0, 5).map(function(p, index) {\n      var revenue = formatKRW(p.total_revenue);\n      var brand = BRAND_NAMES[p.brand] || p.brand;\n      var rating = p.avg_rating ? ' â˜…' + p.avg_rating : '';\n      return (index + 1) + '. *' + (p.product_name || 'ì•Œ ìˆ˜ ì—†ìŒ') + '* [' + brand + ']: â‚©' + revenue + rating;\n    }).join('\\n')\n  : 'ë°ì´í„° ì—†ìŒ';\n\n// ============================================================================\n// 7. ê²½ìŸì‚¬ ëª¨ë‹ˆí„°ë§ í¬ë§·íŒ…\n// ============================================================================\n\nvar competitorAlerts = [];\nfor (var c = 0; c < competitors.length; c++) {\n  var comp = competitors[c];\n\n  // ìˆœìœ„ ë³€ë™ ì•Œë¦¼ (2ë‹¨ê³„ ì´ìƒ ë³€ë™ë§Œ)\n  if (comp.ranking_change && Math.abs(comp.ranking_change) >= 2) {\n    var direction = comp.ranking_change > 0 ? 'ìƒìŠ¹' : 'í•˜ë½';\n    var icon = comp.ranking_change > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\n    competitorAlerts.push(\n      icon + ' ' + comp.product_name + ' [' + comp.source + '] '\n      + comp.prev_ranking + 'ìœ„â†’' + comp.current_ranking + 'ìœ„ (' + direction + ')'\n    );\n  }\n\n  // ê°€ê²© ë³€ë™ ì•Œë¦¼\n  if (comp.price_change && comp.price_change !== 0) {\n    var priceDir = comp.price_change > 0 ? 'ì¸ìƒ' : 'ì¸í•˜';\n    competitorAlerts.push(\n      'ğŸ’° ' + comp.product_name + ' [' + comp.brand + '] '\n      + 'â‚©' + formatKRW(Math.abs(comp.price_change)) + ' ' + priceDir\n    );\n  }\n}\n\nvar competitorSection = competitorAlerts.length > 0\n  ? '\\n*ğŸ” ê²½ìŸì‚¬ ëª¨ë‹ˆí„°ë§*\\n' + competitorAlerts.slice(0, 5).join('\\n') + '\\n'\n  : '';\n\n// ============================================================================\n// 8. ì´ìƒ íƒì§€ ì„¹ì…˜\n// ============================================================================\n\nvar anomalySection = alerts.length > 0\n  ? '\\n*ğŸ”” ì´ìƒ ê°ì§€*\\n' + alerts.join('\\n') + '\\n'\n  : '';\n\n// ============================================================================\n// 9. Slack ë©”ì‹œì§€ ì¡°ë¦½\n// ============================================================================\n\nvar slackMessage = 'ğŸ“Š *ì•³í™ˆ Daily KPI ë¦¬í¬íŠ¸* | ' + today + '\\n\\n'\n  + '*ì „ì²´ ì‹¤ì  (ì–´ì œ ê¸°ì¤€)*\\n'\n  + 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n'\n  + 'ğŸ’° *ì´ ë§¤ì¶œ*: â‚©' + formatKRW(totalRevenue) + ' (' + formatWoW(totalWowRevenue) + ' ' + getTrendIcon(totalWowRevenue) + ')\\n'\n  + 'ğŸ“¦ *ì´ ì£¼ë¬¸*: ' + formatKRW(totalOrders) + 'ê±´ (' + formatWoW(totalWowOrders) + ' ' + getTrendIcon(totalWowOrders) + ')\\n\\n'\n  + '*ë¸Œëœë“œë³„ ì‹¤ì *\\n'\n  + 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n'\n  + brandSections.join('\\n\\n') + '\\n'\n  + anomalySection\n  + '\\n*ğŸ† ë§¤ì¶œ Top 5 ì œí’ˆ*\\n'\n  + top5Formatted + '\\n'\n  + competitorSection + '\\n'\n  + 'â° ë¦¬í¬íŠ¸ ìƒì„±: ' + new Date().toLocaleTimeString('ko-KR');\n\n// ============================================================================\n// 10. ì¶œë ¥ (Slack ë…¸ë“œë¡œ ì „ë‹¬)\n// ============================================================================\n\nreturn [{\n  json: {\n    slackPayload: JSON.stringify({ text: slackMessage }),\n    message: slackMessage,\n    metadata: {\n      date: today,\n      total_revenue: totalRevenue,\n      total_orders: totalOrders,\n      wow_revenue: totalWowRevenue,\n      wow_orders: totalWowOrders,\n      alerts_count: alerts.length,\n      competitor_alerts: competitorAlerts.length,\n      has_anomaly: alerts.length > 0,\n      has_data: true,\n      brands: yesterdayBrands.map(function(b) { return b.brand; })\n    }\n  }\n}];\n"}, "id": "code-transform", "name": "WoW Analysis & Anomaly Detection", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [1000, 300]}, {"parameters": {"jsCode": "// ============================================================================\n// File: slack_send.js\n// Purpose: Slack Webhookìœ¼ë¡œ ì•³í™ˆ KPI ë¦¬í¬íŠ¸ ì „ì†¡ (Code Node)\n// Usage: n8n \"Slack: Send KPI Alert\" Code Nodeì— ë¶™ì—¬ë„£ê¸°\n// ============================================================================\n\n// ============================================================================\n// 1. ì´ì „ ë…¸ë“œì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ \n// ============================================================================\n\nconst items = $input.all();\nconst message = items[0].json.message;\nconst metadata = items[0].json.metadata;\n\n// ============================================================================\n// 2. Slack Webhook ì „ì†¡\n// ============================================================================\n// ì•„ë˜ URLì„ ì‹¤ì œ Slack Webhook URLë¡œ êµì²´í•˜ì„¸ìš”\nconst SLACK_WEBHOOK_URL = 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK_URL';\n\nawait this.helpers.httpRequest({\n  method: 'POST',\n  url: SLACK_WEBHOOK_URL,\n  body: { text: message },\n  json: true\n});\n\n// ============================================================================\n// 3. ì „ì†¡ ê²°ê³¼ ë°˜í™˜\n// ============================================================================\n\nreturn [{\n  json: {\n    status: 'sent',\n    title: 'ì•³í™ˆ Daily KPI ë¦¬í¬íŠ¸',\n    message: message,\n    metadata: metadata,\n    sent_at: new Date().toISOString()\n  }\n}];\n"}, "id": "slack-send", "name": "Slack: Send KPI Alert", "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [1250, 300]}], "connections": {"Schedule: Daily 08:00": {"main": [[{"node": "Supabase: Yesterday Brand KPIs", "type": "main", "index": 0}, {"node": "Supabase: Last Week Brand KPIs", "type": "main", "index": 0}, {"node": "Supabase: Top Products", "type": "main", "index": 0}, {"node": "Supabase: Competitor Changes", "type": "main", "index": 0}]]}, "Supabase: Yesterday Brand KPIs": {"main": [[{"node": "Merge: Collect All Data", "type": "main", "index": 0}]]}, "Supabase: Last Week Brand KPIs": {"main": [[{"node": "Merge: Collect All Data", "type": "main", "index": 1}]]}, "Supabase: Top Products": {"main": [[{"node": "Merge: Collect All Data", "type": "main", "index": 2}]]}, "Supabase: Competitor Changes": {"main": [[{"node": "Merge: Collect All Data", "type": "main", "index": 3}]]}, "Merge: Collect All Data": {"main": [[{"node": "WoW Analysis & Anomaly Detection", "type": "main", "index": 0}]]}, "WoW Analysis & Anomaly Detection": {"main": [[{"node": "Slack: Send KPI Alert", "type": "main", "index": 0}]]}}}